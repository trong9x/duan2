<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>B·∫¢NG TH·ªêNG K√ä CON SU·ªêT M·ªöI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
:root{
  --blue:#0b5ed7;
  --red:#b62e1a;
  --dark:#0f172a;
}
*{box-sizing:border-box}

body{
  margin:0;
  padding:6px;
  font-family:"Segoe UI","Microsoft YaHei",Arial,sans-serif;
  background:#e5e7eb;
}

/* TOOLBAR */
.toolbar{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  margin-bottom:6px;
}
.toolbar button{
  background:var(--blue);
  color:#fff;
  border:none;
  border-radius:8px;
  padding:8px 12px;
}
.toolbar input{
  flex:1;
  min-width:180px;
  padding:8px;
  border-radius:8px;
  border:1px solid #ccc;
}
#status{font-size:12px}

/* QUICK ADD */
#quickAdd{
  background:#fff;
  border-radius:10px;
  padding:6px;
  margin-bottom:6px;
  overflow-x:auto;
}
#quickAdd input{
  width:120px;
  padding:6px;
  font-size:12px;
  border:1px solid #ccc;
  border-radius:6px;
}

/* TABLE */
table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  border-radius:10px;
  overflow:hidden;
}
thead th{
  background:var(--dark);
  color:#fff;
  font-size:12px;
  border:1px solid #334155;
  position:sticky;
  top:0;
}
thead tr:first-child th{background:#991b1b;font-size:16px}
thead tr:nth-child(2) th{background:#7f1d1d;font-size:11px}

th,td{
  border:1px solid #d1d5db;
  padding:6px 8px;
  font-size:13px;
  text-align:center;
  white-space:nowrap;
}
tbody tr:nth-child(even){background:#f9fafb}
tbody tr:hover{background:#e0f2fe}

td[contenteditable]{background:#fff7ed}

.btn{
  background:var(--red);
  color:#fff;
  padding:6px 10px;
  border-radius:8px;
  cursor:pointer;
}
.delete{cursor:pointer;font-size:18px;color:#b91c1c}

@media(max-width:768px){
  table.data-table{
    display:none !important;
  }

  #mobileSort{
    display:flex;
    gap:8px;
    position:sticky;
    top:6px;
    z-index:20;
  }

  #mobileSort select{
    flex:1;
    padding:10px;
    font-size:15px;
    border-radius:10px;
  }

  #mobileList{
    display:flex;
    flex-direction:column;
    gap:12px;
  }
}
/* DESKTOP */
#mobileList{
  display:none;
}

/* MOBILE */
@media(max-width:768px){
  #mobileList{
    display:flex;
    flex-direction:column;
    gap:12px;
  }
}




@media(max-width:768px){
  #quickAdd table{
    display:block;
  }

  #quickAdd tr{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:8px;
  }

  #quickAdd td{
    border:none;
    padding:0;
  }

  #quickAdd input{
    width:100%;
    font-size:14px;
    padding:10px;
  }
}

#mobileAdd{
  display:none;
}

#mobileAdd button{
  width:100%;
  padding:14px;
  font-size:16px;
  border:none;
  border-radius:14px;
  background:var(--blue);
  color:#fff;
}

@media(max-width:768px){
  #mobileAdd{
    display:block;
    position:sticky;
    bottom:10px;
    z-index:50;
    margin-top:10px;
  }

  /* ·∫®N N√öT TR√äN TOOLBAR */
  .toolbar button{
    display:none;
  }
}
#quickAddToggle{
  background:#0b5ed7;
  color:#fff;
  padding:12px;
  border-radius:10px;
  text-align:center;
  font-weight:600;
  margin-bottom:6px;
}

@media(max-width:768px){
  #quickAdd{
    display:none;
  }
  #quickAdd.open{
    display:block;
  }
}
/* MOBILE DELETE */
.card{
  position:relative;
}

.card .delete-btn{
  position:absolute;
  top:8px;
  right:8px;
  font-size:18px;
  cursor:pointer;
  color:#dc2626;
}

/* FORM NH·∫¨P MOBILE ƒê·∫∏P ‚Äì KH√îNG L∆Ø·ªöT NGANG */
.quick-form{
  display:grid;
  grid-template-columns:1fr;
  gap:10px;
}

@media(min-width:769px){
  .quick-form{
    grid-template-columns:repeat(4,1fr); /* desktop g·ªçn */
  }
}

.quick-form input{
  width:100%;
  padding:12px;
  font-size:15px;
  border-radius:10px;
  border:1px solid #d1d5db;
}

</style>
</head>

<body>

<div class="toolbar">
  <button onclick="addRow()">‚ûï TH√äM D√íNG</button>
  <input id="search" list="suggestions" placeholder="üîç Nh·∫≠p s·ªë / s·ª£i (vd: 150)">
  <datalist id="suggestions"></datalist>
  <span id="status">‚è≥</span>
</div>
 <!-- MOBILE CARD LIST -->
<div id="mobileList"></div>
<!-- MOBILE SORT BAR -->
<div id="mobileSort" style="
  display:none;
  background:#fff;
  padding:8px;
  border-radius:10px;
  margin-bottom:8px;
  gap:6px;
">
  <select id="mobileSortField">
    <option value="quyCach">Quy c√°ch s·ª£i</option>
    <option value="soMet">S·ªë m√©t</option>
    <option value="viTri">V·ªã tr√≠</option>
    <option value="ngay">Ng√†y</option>
  </select>

  <select id="mobileSortDir">
    <option value="asc">‚¨Ü TƒÉng d·∫ßn</option>
    <option value="desc">‚¨á Gi·∫£m d·∫ßn</option>
  </select>
</div>

<!-- D√íNG NH·∫¨P NHANH -->
<div id="quickAddWrap">

  <div id="quickAddToggle" onclick="toggleQuickAdd()">
    ‚ûï Nh·∫≠p con su·ªët
  </div>

  <div id="quickAdd">

  </div>
  <div class="quick-form">
  <input data-f="soMay" type="number" placeholder="S·ªë m√°y">
  <input data-f="donHang" placeholder="ƒê∆°n h√†ng">
  <input data-f="quyCach" placeholder="Quy c√°ch s·ª£i">
  <input data-f="may" placeholder="M√°y">
  <input data-f="soConSuot" type="number" placeholder="Con su·ªët">
  <input data-f="khoTrong" placeholder="Kh·ªï trong">
  <input data-f="khoNgoai" placeholder="Kh·ªï ngo√†i">
  <input data-f="soMet" type="number" placeholder="S·ªë m√©t">
  <input data-f="nguyenDai" placeholder="Nguy√™n d√†i">
  <input data-f="nguyenNgoai" placeholder="Ngo·∫°i quan">
  <input data-f="soLo" placeholder="S·ªë l√¥"
    onblur="autoFillQuyCachFromSoLo(this.value)">
  <input data-f="viTri" placeholder="V·ªã tr√≠">
  <input data-f="ngay" type="date" placeholder="Ng√†y">
</div>

</div>

<table class="data-table">
<thead>
<tr><th colspan="16">Êñ∞ÁõòÂ§¥ÁªüËÆ°Ë°® ‚Äî B·∫¢NG TH·ªêNG K√ä CON SU·ªêT M·ªöI</th></tr>
<tr><th colspan="16">Ê¨¢Ëøé üòÅ</th></tr>
<tr>
  <th rowspan="2" data-field="soMay">S·ªê M√ÅY</th>
  <th rowspan="2" data-field="donHang">ƒê∆†N H√ÄNG</th>
  <th rowspan="2" data-field="quyCach">QUY C√ÅCH S·ª¢I</th>
  <th rowspan="2" data-field="may">M√ÅY</th>
  <th rowspan="2" data-field="soConSuot">S·ªê CON SU·ªêT</th>
  <th colspan="2">KH·ªî S·ª¢I</th>
  <th rowspan="2" data-field="soMet">S·ªê M√âT</th>
  <th colspan="2">NGUY√äN S·ª¢I</th>
  <th rowspan="2" data-field="soLo">S·ªê L√î</th>
  <th rowspan="2" data-field="viTri">V·ªä TR√ç</th>
  <th rowspan="2" data-field="ngay">NG√ÄY</th>
  <th rowspan="2">L√äN M√ÅY</th>
  <th rowspan="2">üîí</th>
  <th rowspan="2">‚ùå</th>
</tr>

<tr>
  <th>TRONG</th><th>NGO√ÄI</th><th>D√ÄI</th><th>NGO·∫†I QUAN</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyAJ9dZW55b8WxF22cocPIB9bdsAGBHW-k",
  databaseURL:"https://quan-ly-may-det-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const ref=firebase.database().ref("consuot");
const statusEl=document.getElementById("status");
// üîπ b·∫£ng s·ªë l√¥ chu·∫©n (t·∫°o t·ª´ solo-manager.html)
const soLoRef = firebase.database().ref("solos");


firebase.database().ref(".info/connected").on("value",s=>{
  statusEl.innerText=s.val()?"üü¢ ƒê√£ k·∫øt n·ªëi":"üî¥ M·∫•t k·∫øt n·ªëi";
});

const tbody=document.getElementById("tbody");
const search=document.getElementById("search");
const datalist=document.getElementById("suggestions");

/* ADD FROM QUICK ROW */
function addRow(){
  const data={};
  document.querySelectorAll("#quickAdd input").forEach(i=>{
    data[i.dataset.f]=i.value.trim();
  });

  if(Object.values(data).every(v=>!v))
    return alert("‚ö†Ô∏è Ch∆∞a nh·∫≠p d·ªØ li·ªáu");

  ref.push(data);

  // ‚úÖ HI·ªÜU ·ª®NG L∆ØU TH√ÄNH C√îNG
  showSaved();

  document.querySelectorAll("#quickAdd input").forEach(i=>i.value="");
}


/* CREATE ROW */
function createRow(d){
  const tr=document.createElement("tr");
  tr.dataset.key=d._key;

  const f=["soMay","donHang","quyCach","may","soConSuot","khoTrong","khoNgoai","soMet","nguyenDai","nguyenNgoai","soLo","viTri","ngay"];
  f.forEach(k=>{
  const td=document.createElement("td");
  td.contentEditable = !d.locked; // üîí ch·ªâ kh√≥a √¥
  td.innerText=d[k]||"";
  td.oninput = () => {
  ref.child(tr.dataset.key).update({[k]:td.innerText});
  flashCell(td); // ‚úÖ hi·ªáu ·ª©ng l∆∞u
};

  tr.appendChild(td);
});


  const tdBtn = document.createElement("td");
const btn = document.createElement("div");
btn.className = "btn";

if(d.mayLen){
  btn.innerText = `${d.mayLen} ‚è± ${d.timeLen}`;
}else{
  btn.innerText = "L√äN M√ÅY";
}

btn.onclick = () => lenMayByKey(tr.dataset.key, d);

tdBtn.appendChild(btn);
tr.appendChild(tdBtn);



  const tdLock=document.createElement("td");
  tr.appendChild(tdLock);

  const tdDel=document.createElement("td");
  tdDel.innerText="üóëÔ∏è";
  tdDel.className="delete";
  tdDel.onclick=()=>ref.child(tr.dataset.key).remove();
  tr.appendChild(tdDel);
  if(d.locked){
  tr.classList.add("locked");
}


  tbody.appendChild(tr);
}


/* LOAD (DESKTOP + MOBILE) */
const mobileList = document.getElementById("mobileList");

ref.on("value", s => {
  tbody.innerHTML = "";
  mobileList.innerHTML = "";

  s.forEach(c => {
    const d = {...c.val(), _key: c.key};
    createRow(d);     // desktop table
    createCard(d);    // mobile card
  });
});

/* SEARCH ‚Äì CH·ªà THEO S·ª¢I */
const YARN_COL=2;
/* SEARCH ‚Äì DESKTOP + MOBILE */
search.addEventListener("input",()=>{
  const kw = search.value.toLowerCase().trim();
  datalist.innerHTML = "";

  // desktop table
  [...tbody.rows].forEach(tr=>{
    const yarn = tr.cells[2]?.innerText.toLowerCase() || "";
    tr.style.display = !kw || yarn.includes(kw) ? "" : "none";
  });

  // mobile cards
  [...mobileList.children].forEach(card=>{
    const yarn = card.querySelector("h3")?.innerText.toLowerCase() || "";
    card.style.display = !kw || yarn.includes(kw) ? "" : "none";
  });

  if(!kw) return;

  const set=new Set();
  [...tbody.rows].forEach(tr=>{
    const t=tr.cells[2]?.innerText;
    if(t && t.toLowerCase().includes(kw)) set.add(t);
  });

  [...set].slice(0,20).forEach(v=>{
    const o=document.createElement("option");
    o.value=v;
    datalist.appendChild(o);
  });
});

/* L√äN M√ÅY ‚Äì D√ôNG CHUNG DESKTOP + MOBILE */
/* L√äN M√ÅY ‚Äì D√ôNG CHUNG DESKTOP + MOBILE */
function lenMayByKey(key, data){
  if(data.locked){
    if(!confirm("üîì Ph·ª•c h·ªìi d√≤ng n√†y?")) return;
    ref.child(key).update({
      mayLen:null,
      timeLen:null,
      locked:false
    });
    return;
  }

  if(!data.viTri){
    alert("‚ö†Ô∏è Ch∆∞a nh·∫≠p V·ªä TR√ç");
    return;
  }

  const may = prompt("Nh·∫≠p M√ÅY l√™n:");
  if(!may) return;

  ref.child(key).update({
    mayLen: may,
    timeLen: new Date().toLocaleString("vi-VN"),
    locked: true
  });
}



  

function createCard(d){
  const card=document.createElement("div");
  card.className="card";
  if(d.locked) card.classList.add("locked");

  card.innerHTML=`
    <div class="delete-btn">‚ùå</div>

    <h3>${d.quyCach||"(Ch∆∞a c√≥ s·ª£i)"}</h3>
    <div class="row"><span>ƒê∆°n h√†ng</span><b>${d.donHang||""}</b></div>
    <div class="row"><span>M√°y</span><b>${d.may||""}</b></div>
    <div class="row"><span>V·ªã tr√≠</span><b>${d.viTri||""}</b></div>
    <div class="row"><span>S·ªë m√©t</span><b>${d.soMet||""}</b></div>
    <div class="row"><span>Ng√†y</span><b>${d.ngay||""}</b></div>
  `;

  // üî¥ X√ìA D√íNG (MOBILE)
  card.querySelector(".delete-btn").onclick = ()=>{
    if(confirm("‚ùå X√≥a d√≤ng n√†y?")){
      ref.child(d._key).remove();
    }
  };

  const btn=document.createElement("div");
  btn.className="btn";
  btn.innerText=d.mayLen
    ? `${d.mayLen} ‚è± ${d.timeLen}`
    : "L√äN M√ÅY";

  btn.onclick = () => lenMayByKey(d._key, d);

  card.appendChild(btn);
  mobileList.appendChild(card);
}


let sortState = {}; // l∆∞u tr·∫°ng th√°i ‚Üë ‚Üì

document.querySelectorAll("thead th[data-field]").forEach(th=>{
  th.style.cursor = "pointer";
  th.addEventListener("click", ()=>{
    const field = th.dataset.field;
    const dir = sortState[field] === "asc" ? "desc" : "asc";
    sortState = {}; // reset c·ªôt kh√°c
    sortState[field] = dir;
    sortTable(field, dir);
    updateSortIcon(th, dir);
  });
});

function sortTable(field, dir){
  const rows = [...tbody.rows];

  rows.sort((a,b)=>{
    const get = (tr)=>{
      const map = {
        soMay:0, donHang:1, quyCach:2, may:3,
        soConSuot:4, soMet:7, soLo:10, viTri:11, ngay:12
      };
      return tr.cells[map[field]]?.innerText.trim() || "";
    };

    let A = get(a), B = get(b);

    // s·ªë
    if(!isNaN(A) && !isNaN(B)){
      A = Number(A); B = Number(B);
    }
    // ng√†y
    else if(/\d{4}/.test(A) && /\d{4}/.test(B)){
      A = new Date(A); B = new Date(B);
    }
    // ch·ªØ
    else{
      A = A.toLowerCase();
      B = B.toLowerCase();
    }

    return dir==="asc" ? A>B?1:-1 : A<B?1:-1;
  });

  rows.forEach(r=>tbody.appendChild(r));
}

function updateSortIcon(th, dir){
  document.querySelectorAll("thead th").forEach(t=>{
    t.innerHTML = t.innerText.replace(" ‚Üë","").replace(" ‚Üì","");
  });
  th.innerHTML += dir==="asc" ? " ‚Üë" : " ‚Üì";
}
function isMobile(){
  return window.innerWidth <= 768;
}

const mobileSortBar = document.getElementById("mobileSort");

function toggleMobileSort(){
  mobileSortBar.style.display = isMobile() ? "flex" : "none";
}
window.addEventListener("resize", toggleMobileSort);
toggleMobileSort();
const mobileSortField = document.getElementById("mobileSortField");
const mobileSortDir   = document.getElementById("mobileSortDir");

mobileSortField.onchange = mobileSortDir.onchange = sortMobileCards;

function sortMobileCards(){
  const field = mobileSortField.value;
  const dir   = mobileSortDir.value;

  const cards = [...mobileList.children];

  cards.sort((a,b)=>{
    const getVal = (card)=>{
      if(field==="quyCach"){
        return card.querySelector("h3")?.innerText || "";
      }
      const map={
        soMet:"S·ªë m√©t",
        viTri:"V·ªã tr√≠",
        ngay:"Ng√†y"
      };
      const row=[...card.querySelectorAll(".row")]
        .find(r=>r.innerText.includes(map[field]));
      return row?.querySelector("b")?.innerText || "";
    };

    let A=getVal(a), B=getVal(b);

    if(!isNaN(A) && !isNaN(B)){
      A=Number(A); B=Number(B);
    }else if(/\d{4}/.test(A) && /\d{4}/.test(B)){
      A=new Date(A); B=new Date(B);
    }else{
      A=A.toLowerCase();
      B=B.toLowerCase();
    }

    return dir==="asc" ? A>B?1:-1 : A<B?1:-1;
  });

  cards.forEach(c=>mobileList.appendChild(c));
}

// üîπ T·ª∞ ƒê·ªòNG NH·∫¢Y QUY C√ÅCH S·ª¢I KHI NH·∫¨P S·ªê L√î
function autoFillQuyCachFromSoLo(soLo){
  soLo = soLo.trim();
  if(!soLo) return;

  // √¥ quy c√°ch s·ª£i trong d√≤ng nh·∫≠p nhanh
  const quyCachInput =
    document.querySelector('#quickAdd [data-f="quyCach"]');

  // n·∫øu ƒë√£ c√≥ r·ªìi th√¨ kh√¥ng ghi ƒë√®
  if(quyCachInput.value) return;

  // tra b·∫£ng s·ªë l√¥ chu·∫©n
  soLoRef.child(soLo).once("value", snap=>{
    if(!snap.exists()){
      alert("‚ö†Ô∏è S·ªë l√¥ ch∆∞a ƒë∆∞·ª£c khai b√°o trong h·ªá th·ªëng");
      return;
    }

    const data = snap.val();
    quyCachInput.value = data.quyCach || "";
  });
}

function toggleQuickAdd(){
  document.getElementById("quickAdd").classList.toggle("open");
}
function flashCell(el){
  el.style.background = "#dcfce7"; // xanh nh·∫°t
  setTimeout(()=>{
    el.style.background = "";
  }, 400);
}

function showSaved(){
  let toast = document.getElementById("toastSaved");
  if(!toast){
    toast = document.createElement("div");
    toast.id = "toastSaved";
    toast.innerText = "‚úÖ ƒê√£ l∆∞u";
    Object.assign(toast.style,{
      position:"fixed",
      bottom:"20px",
      left:"50%",
      transform:"translateX(-50%)",
      background:"#16a34a",
      color:"#fff",
      padding:"10px 18px",
      borderRadius:"999px",
      fontSize:"14px",
      zIndex:9999,
      opacity:0,
      transition:"0.3s"
    });
    document.body.appendChild(toast);
  }
  toast.style.opacity=1;
  setTimeout(()=>toast.style.opacity=0,1200);
}



</script>

</body>
</html>

</body>
</html>
