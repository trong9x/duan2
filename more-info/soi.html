<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quáº£n lÃ½ sá»£i â€“ Táº¡o Ä‘Æ¡n</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#f2f3f5;padding:12px}
h2{text-align:center;margin-bottom:10px}

.box{background:#fff;padding:12px;border-radius:14px;margin-bottom:10px}
input,select{width:100%;padding:12px;font-size:16px;border-radius:10px;border:1px solid #ddd}
button{padding:12px;border-radius:10px;border:none;font-weight:600;cursor:pointer}

.add{background:#2ecc71;color:#fff}
.assign{background:#3498db;color:#fff}
.del{background:#e74c3c;color:#fff}

#soiList{list-style:none;padding:0;margin:0}
#soiList li{background:#fff;padding:12px;border-radius:12px;margin-bottom:8px}
.row{display:flex;gap:6px}
.qty-input{flex:1;text-align:center}

.order-item{
  background:#eaf2ff;
  padding:8px;
  border-radius:8px;
  display:flex;
  align-items:center;
  gap:8px;
  margin-bottom:6px;
}
.order-item input{
  width:80px;
  padding:6px;
  text-align:center;
}
</style>
</head>

<body>

<h2>ğŸ§µ QUáº¢N LÃ Sá»¢I â€“ Táº O ÄÆ N</h2>

<!-- THÃŠM Sá»¢I -->
<div class="box">
  <input id="soiName" placeholder="TÃªn sá»£i">
  <div style="height:6px"></div>
  <input id="soiQty" type="number" placeholder="Sá»‘ lÆ°á»£ng">
  <div style="height:8px"></div>
  <button class="add" style="width:100%" onclick="addSoi()">â• ThÃªm sá»£i</button>
</div>

<!-- DANH SÃCH Sá»¢I -->
<ul id="soiList"></ul>

<!-- ÄÆ N HÃ€NG -->
<div class="box">
  <h3>ğŸ“¦ ÄÆ¡n hÃ ng hiá»‡n táº¡i</h3>
  <div id="orderList"></div>

  <b>ğŸ­ Chá»n mÃ¡y</b>
  <select id="machineKey">
    <option value="1101">1101D</option>
    <option value="1102">1102D</option>
    <option value="1103">1103F</option>
    <option value="1111">1111B#</option>
  </select>

  <div style="height:6px"></div>
  <b>Tá»« trá»¥c</b>
  <select id="fromAxle"></select>

  <div style="height:6px"></div>
  <b>Äáº¿n trá»¥c</b>
  <select id="toAxle"></select>

  <div style="height:10px"></div>
  <button class="assign" style="width:100%" onclick="createOrder()">
    âš™ï¸ Táº O ÄÆ N â†’ GÃN TRá»¤C
  </button>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyAJ9dZW5b8WxF22cocPIB9bdsAGBHW-k",
  databaseURL: "https://quan-ly-may-det-default-rtdb.asia-southeast1.firebasedatabase.app"
});

const db = firebase.database();
const soiRef = db.ref("soi");

let currentOrder = [];

/* INIT L1 â†’ L8 */
for(let i=1;i<=8;i++){
  fromAxle.innerHTML += `<option value="${i}">L${i}</option>`;
  toAxle.innerHTML   += `<option value="${i}">L${i}</option>`;
}
fromAxle.value = 1;
toAxle.value   = 8;

/* RENDER DANH SÃCH Sá»¢I */
soiRef.on("value", snap=>{
  soiList.innerHTML="";
  snap.forEach(s=>{
    const v = s.val();
    const li = document.createElement("li");

    li.innerHTML = `
      <b>${v.name}</b>
      <div class="row">
        <input class="qty-input" type="number" value="${v.qty||0}">
        <button class="assign">+ ÄÆ¡n</button>
        <button class="del">X</button>
      </div>
    `;
    soiList.appendChild(li);

    const qtyInput = li.querySelector(".qty-input");

    li.querySelector(".assign").onclick = () => {
      currentOrder.push({
        name: v.name,
        qty: Number(qtyInput.value) || 0
      });
      renderOrder();
    };

    li.querySelector(".del").onclick = () => {
      if(confirm("XÃ³a sá»£i?")) soiRef.child(s.key).remove();
    };
  });
});

/* RENDER ÄÆ N â€“ CHO Sá»¬A SL */
function renderOrder(){
  orderList.innerHTML = "";

  currentOrder.forEach((s, i) => {
    orderList.innerHTML += `
      <div class="order-item">
        <div style="flex:1">${i+1}. ${s.name}</div>

        <input
          type="number"
          value="${s.qty}"
          onchange="updateOrderQty(${i}, this.value)"
        />

        <button class="del" onclick="removeOrderItem(${i})">âŒ</button>
      </div>
    `;
  });
}

function updateOrderQty(index, value){
  currentOrder[index].qty = Number(value) || 0;
}

function removeOrderItem(index){
  if(!confirm("XÃ³a sá»£i khá»i Ä‘Æ¡n?")) return;
  currentOrder.splice(index,1);
  renderOrder();
}

/* THÃŠM Sá»¢I */
function addSoi(){
  if(!soiName.value.trim()) return alert("Nháº­p tÃªn sá»£i");
  soiRef.push({
    name: soiName.value,
    qty: Number(soiQty.value) || 0,
    createdAt: Date.now()
  });
  soiName.value="";
  soiQty.value="";
}

/* Táº O ÄÆ N â€“ GÃN TRá»¤C (KHÃ”NG GIá»šI Háº N) */
function createOrder(){
  if(currentOrder.length === 0){
    alert("ChÆ°a cÃ³ sá»£i trong Ä‘Æ¡n");
    return;
  }

  const machine = machineKey.value;
  const from = Number(fromAxle.value);
  const to   = Number(toAxle.value);

  if(from > to){
    alert("Sai trá»¥c");
    return;
  }

  const base = db.ref(`machines/${machine}/axles`);

  // clear trá»¥c
  for(let i=from;i<=to;i++){
    base.child(i).remove();
  }

  // gÃ¡n â€“ láº·p sá»£i náº¿u thiáº¿u
  let idx = 0;
  for(let axle = from; axle <= to; axle++){
    const s = currentOrder[idx % currentOrder.length];

    base.child(axle).set({
      material: s.name,
      qty: s.qty,
      hour: 0,
      location: "",
      updatedAt: Date.now()
    });

    idx++;
  }

  db.ref("orders").push({
    machine,
    fromAxle: from,
    toAxle: to,
    items: currentOrder,
    createdAt: Date.now()
  });

  currentOrder = [];
  renderOrder();
  alert(`ğŸ”¥ ÄÃ£ gÃ¡n L${from} â†’ L${to} cho mÃ¡y ${machine}`);
}
</script>

</body>
</html>
