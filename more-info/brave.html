<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Nh·∫≠p s·∫£n l∆∞·ª£ng</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#f2f2f2}

/* HEADER */
.header{
  position:fixed;top:0;left:0;right:0;height:56px;
  background:#27ae60;color:#fff;
  display:flex;align-items:center;justify-content:center;
  font-size:18px;font-weight:bold;z-index:10;
}

/* CONTENT */
.content{padding:70px 12px 100px}
.card{
  background:#fff;border-radius:18px;padding:16px;
  max-width:520px;margin:auto;
  box-shadow:0 6px 18px rgba(0,0,0,.15);
}

label{font-weight:600;margin-top:12px;display:block;font-size:14px}
input,select{
  width:100%;padding:14px;margin-top:6px;
  border-radius:14px;border:1px solid #ccc;font-size:16px
}

button.scan{
  margin-top:8px;
  background:#2980b9;
  border:none;color:#fff;
  padding:12px;
  border-radius:14px;
  width:100%;font-size:16px
}

video{
  width:100%;
  margin-top:12px;
  border-radius:16px;
  display:none;
}

/* FOOTER */
.footer{
  position:fixed;bottom:0;left:0;right:0;
  background:#fff;padding:10px;
  box-shadow:0 -4px 12px rgba(0,0,0,.15);
}
button.save{
  width:100%;padding:16px;font-size:18px;
  background:#27ae60;color:#fff;border:none;border-radius:18px
}
</style>
</head>

<body>

<div class="header">üì¶ Nh·∫≠p s·∫£n l∆∞·ª£ng</div>

<div class="content">
<div class="card">

<label>Ng√†y</label>
<input id="date" type="date">

<label>M√°y</label>
<select id="machine">
  <option value="">-- ch·ªçn m√°y --</option>
  <option>1101D</option>
  <option>1102D</option>
  <option>1103F</option>
  <option>1104F</option>
</select>

<label>Tr·ª•c</label>
<select id="axle">
  <option value="">-- ch·ªçn tr·ª•c --</option>
  <option>L1</option><option>L2</option><option>L3</option>
  <option>L4</option><option>L5</option>
</select>

<hr>

<label>QR / B·ªô s·ªë</label>
<input id="qr" placeholder="QR|TEN|LO|SO_SOI|SO_MET">
<button class="scan" type="button" onclick="startScan()">üì∑ Qu√©t QR</button>

<video id="video" playsinline></video>

<label>T√™n v·∫≠t li·ªáu</label>
<input id="materialName">

<label>S·ªë l√¥</label>
<input id="lot">

<label>S·ªë s·ª£i</label>
<input id="quantity" type="number">

<label>S·ªë m√©t</label>
<input id="meter" type="number">

<hr>

<label>V·ªã tr√≠</label>
<input id="position">

<label>Ca</label>
<select id="shift">
  <option value="A">Ca A</option>
  <option value="B">Ca B</option>
</select>

<label>Ng∆∞·ªùi ph·ª• tr√°ch</label>
<input id="person">

</div>
</div>

<div class="footer">
  <button class="save" onclick="save()">‚úÖ OK</button>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ===== FIREBASE INIT ===== */
firebase.initializeApp({
  apiKey:"AIzaSyAJ9dZW5b8WxF22cocPIB9bdsAGBHW-k",
  databaseURL:"https://quan-ly-may-det-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db = firebase.database();

/* ===== SET DATE ===== */
date.value = new Date().toISOString().slice(0,10);

/* ===== SAVE DATA ===== */
function save(){
  const data = {
    date: date.value,
    machine: machine.value,
    axle: axle.value,
    material:{
      qr: qr.value.trim(),
      name: materialName.value.trim(),
      lot: lot.value.trim(),
      fiber: Number(quantity.value),
      meter: Number(meter.value)
    },
    position: position.value.trim(),
    shift: shift.value,
    person: person.value.trim(),
    createdAt: Date.now()
  };

  if(!data.machine || !data.axle || !data.material.name ||
     !quantity.value || !data.person){
    alert("‚ùó Nh·∫≠p thi·∫øu th√¥ng tin");
    return;
  }

  db.ref(`production/${data.machine}/axle_${data.axle}`)
    .push(data)
    .then(()=>{
      alert("‚úÖ ƒê√£ l∆∞u");
      location.reload();
    })
    .catch(err=>{
      alert("‚ùå L·ªói l∆∞u d·ªØ li·ªáu");
      console.error(err);
    });
}

/* ===== QR SCAN (SAFARI / iOS) ===== */
let videoStream = null;
let detector = null;

async function startScan(){
  if(!("BarcodeDetector" in window)){
    alert("‚ùó Safari c·∫ßn iOS 16+");
    return;
  }

  detector = new BarcodeDetector({formats:["qr_code"]});
  video.style.display="block";

  videoStream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode:"environment"}
  });

  video.srcObject = videoStream;
  await video.play();
  scanLoop();
}

async function scanLoop(){
  if(video.readyState === video.HAVE_ENOUGH_DATA){
    const codes = await detector.detect(video);
    if(codes.length){
      const value = codes[0].rawValue;
      qr.value = value;
      autoParse(value);
      stopScan();
      return;
    }
  }
  requestAnimationFrame(scanLoop);
}

function stopScan(){
  video.pause();
  video.style.display="none";
  if(videoStream){
    videoStream.getTracks().forEach(t=>t.stop());
  }
}

/* ===== AUTO PARSE QR ===== */
function autoParse(text){
  const p = text.split("|");
  if(p.length >= 5){
    qr.value = p[0];
    materialName.value = p[1];
    lot.value = p[2];
    quantity.value = p[3];
    meter.value = p[4];
  }
}
</script>

</body>
</html>
