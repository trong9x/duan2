<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nh·∫≠p s·∫£n l∆∞·ª£ng QR</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#f2f2f2}

/* HEADER */
.header{
  position:fixed;top:0;left:0;right:0;height:56px;
  background:#27ae60;color:#fff;
  display:flex;align-items:center;justify-content:center;
  font-size:18px;font-weight:bold;z-index:10
}

/* CONTENT */
.content{padding:70px 12px 110px}
.card{
  background:#fff;border-radius:18px;padding:16px;
  max-width:520px;margin:auto;
  box-shadow:0 6px 18px rgba(0,0,0,.15)
}

label{font-weight:600;margin-top:12px;display:block;font-size:14px}
input,select{
  width:100%;padding:14px;margin-top:6px;
  border-radius:14px;border:1px solid #ccc;font-size:16px
}

button{
  width:100%;padding:16px;font-size:18px;
  border:none;border-radius:18px;color:#fff
}
.scan{background:#2980b9;margin-bottom:12px}
.save{background:#27ae60}

/* QR PREVIEW (B·∫ÆT BU·ªòC CHO IPHONE) */
#preview{
  display:none;
  width:100%;
  min-height:260px;
  background:#000;
  border-radius:14px;
  overflow:hidden;
  margin-bottom:12px;
}

/* FOOTER */
.footer{
  position:fixed;bottom:0;left:0;right:0;
  background:#fff;padding:10px;
  box-shadow:0 -4px 12px rgba(0,0,0,.15)
}
</style>
</head>

<body>

<div class="header">üì¶ Nh·∫≠p s·∫£n l∆∞·ª£ng (QR)</div>

<div class="content">
<div class="card">

<button class="scan" onclick="startScan()">üì∑ Qu√©t QR tem</button>

<!-- ‚ö†Ô∏è PH·∫¢I L√Ä DIV ‚Äì KH√îNG D√ôNG VIDEO -->
<div id="preview"></div>

<label>Ng√†y</label>
<input id="date" type="date">

<label>M√°y</label>
<select id="machine">
  <option value="">-- ch·ªçn m√°y --</option>
  <option>1101D</option>
  <option>1102D</option>
  <option>1103F</option>
</select>

<label>Tr·ª•c</label>
<select id="axle">
  <option value="">-- ch·ªçn tr·ª•c --</option>
  <option>L1</option>
  <option>L2</option>
  <option>L3</option>
</select>

<label>Nguy√™n li·ªáu</label>
<input id="material" readonly>

<label>S·ªë l√¥</label>
<input id="lot" readonly>

<label>S·ªë m√©t tem</label>
<input id="meter" readonly>

<label>S·ªë l∆∞·ª£ng nh·∫≠p</label>
<input id="quantity" type="number">

<label>Ca</label>
<select id="shift">
  <option value="">-- ch·ªçn ca --</option>
  <option value="A">Ca A</option>
  <option value="B">Ca B</option>
</select>

<label>Ng∆∞·ªùi ph·ª• tr√°ch</label>
<input id="person">

</div>
</div>

<div class="footer">
  <button class="save" onclick="save()">‚úÖ L∆ØU</button>
</div>

<!-- QR LIB -->
<script src="https://unpkg.com/html5-qrcode"></script>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyAJ9dZW5b8WxF22cocPIB9bdsAGBHW-k",
  databaseURL: "https://quan-ly-may-det-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db = firebase.database();

/* ================= SET TODAY ================= */
date.value = new Date().toISOString().slice(0,10);

/* ================= QR SCAN ================= */
let scanner = null;

function startScan(){
  const box = document.getElementById("preview");
  box.style.display = "block";

  if(scanner){
    scanner.stop().catch(()=>{});
  }

  scanner = new Html5Qrcode("preview");

  scanner.start(
    { video: { facingMode: { ideal: "environment" } } }, // CHU·∫®N IPHONE
    { fps: 10, qrbox: 250 },
    text => {
      scanner.stop().then(()=>{
        box.style.display = "none";
      });
      handleQR(text);
    },
    error => {}
  ).catch(err=>{
    alert("‚ùå Kh√¥ng m·ªü ƒë∆∞·ª£c camera. Ki·ªÉm tra quy·ªÅn Camera.");
  });
}

/* ================= HANDLE QR ================= */
function handleQR(text){
  // QR: type=material&id=XXXX
  const params = {};
  text.split("&").forEach(p=>{
    const [k,v] = p.split("=");
    params[k] = v;
  });

  if(params.type === "material"){
    loadMaterial(params.id);
  }else{
    alert("‚ùå QR kh√¥ng h·ª£p l·ªá");
  }
}

/* ================= LOAD MATERIAL ================= */
function loadMaterial(id){
  db.ref("materials/" + id).once("value").then(snap=>{
    if(!snap.exists()){
      alert("‚ùå Kh√¥ng t√¨m th·∫•y tem");
      return;
    }
    const d = snap.val();
    material.value = d.material || "";
    lot.value = d.lot || "";
    meter.value = d.meter || "";
  });
}

/* ================= SAVE ================= */
function save(){
  const data = {
    date: date.value,
    machine: machine.value,
    axle: axle.value,
    material: material.value,
    lot: lot.value,
    meterTem: Number(meter.value),
    quantity: Number(quantity.value),
    shift: shift.value,
    person: person.value,
    createdAt: Date.now()
  };

  if(!data.machine || !data.axle || !data.material ||
     !data.quantity || !data.shift || !data.person){
    alert("‚ùó Nh·∫≠p ƒë·ªß th√¥ng tin");
    return;
  }

  db.ref("production").push(data).then(()=>{
    alert("‚úÖ ƒê√£ l∆∞u s·∫£n l∆∞·ª£ng");
    quantity.value = "";
    quantity.focus();
  });
}
</script>

</body>
</html>


