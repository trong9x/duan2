<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç´§æ€¥è®¢å• | Báº£ng Ä‘Æ¡n hÃ ng gáº¥p</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
  .action-col{
  display:flex;
  flex-direction:column;
  gap:6px;
  align-items:center;
}
.action-col button{
  width:42px;
  height:36px;
  border-radius:8px;
}

:root{
  --blue:#2563eb;
  --blue-dark:#1e40af;
  --green:#22c55e;
  --yellow:#facc15;
  --red:#ef4444;
  --gray:#6b7280;
}

body{font-family:Arial;background:#f4f6f8;padding:16px}
h2{text-align:center;margin-bottom:10px}

/* ===== INPUT ===== */
input,select,button{
  padding:8px;
  border-radius:6px;
  border:1px solid #c7d2fe
}
button{border:none;font-weight:600;cursor:pointer}

/* ===== BUTTON ===== */
.add-btn{background:var(--green);color:#fff}
.save-btn{background:#0ea5e9;color:#fff}
.done-btn{background:#22c55e;color:#fff}
.edit{background:#facc15}
.delete{background:var(--red);color:#fff}

/* ===== TABLE ===== */
table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  border-radius:10px;
  overflow:hidden
}
th,td{
  padding:8px;
  border-bottom:1px solid #e5e7eb;
  text-align:center
}
th{
  background:linear-gradient(90deg,var(--blue),var(--blue-dark));
  color:#fff
}

/* ===== TRáº NG THÃI ===== */
.done{
  background:#f1f5f9;
  color:var(--gray);
  text-decoration:line-through
}

/* ===== Cáº¢NH BÃO ===== */
.level-green{background:#f0fdf4}
.level-yellow{background:#fffbeb}
.level-red{
  background:#fee2e2;
  animation:blink 1.2s infinite;
  font-weight:bold;
}
@keyframes blink{
  0%{background:#fee2e2}
  50%{background:#fecaca}
  100%{background:#fee2e2}
}

/* ===== KHÃC ===== */
.position-box{
  background:#ecfeff;
  border:1px solid #67e8f9;
  color:#0e7490;
  padding:4px 8px;
  border-radius:6px;
  font-weight:600
}
.locked{
  padding:6px 12px;
  background:#e5e7eb;
  border-radius:999px;
  font-size:12px;
  font-weight:600
}

/* ===== MOBILE ===== */
@media(max-width:768px){
  table{display:block}
  thead{display:none}

  tbody{display:block}
  tbody tr{
    display:block;
    margin-bottom:14px;
    background:#fff;
    border-radius:12px;
    padding:10px;
  }

  tbody td{
    display:flex;
    justify-content:space-between;
    border:none;
    padding:4px 0;
  }
  tbody td::before{
    font-weight:600;
    color:#374151;
  }

  tbody td:nth-child(1)::before{content:"è®¢å•";}
  tbody td:nth-child(2)::before{content:"æœºå™¨";}
  tbody td:nth-child(3)::before{content:"åŸæ–™";}
  tbody td:nth-child(4)::before{content:"æ•°é‡";}
  tbody td:nth-child(5)::before{content:"æ—¥æœŸ";}
  tbody td:nth-child(6)::before{content:"ç±³æ•°";}
  tbody td:nth-child(7)::before{content:"å‘˜å·¥";}
  tbody td:nth-child(8)::before{content:"é”­ä½";}
  tbody td:nth-child(9)::before{content:"ä¼˜å…ˆ";}
  tbody td:nth-child(10)::before{content:"çŠ¶æ€";}
  tbody td:nth-child(11)::before{content:"æ“ä½œ";}

}

/* ===== ROW Gá»ŒN (VáºªN GIá»® NÃšT) ===== */
.compact-row td{
  padding:4px 6px !important;   /* giáº£m chiá»u cao */
  font-size:13px;               /* chá»¯ nhá» hÆ¡n chÃºt */
  line-height:1.2;
}

.compact-row .action-col{
  gap:4px;
}

.compact-row .action-col button{
  width:36px;
  height:30px;
  font-size:14px;
}

</style>
</head>

<body>
  
  <a style="color: #ef4444;" href="/more-info/done.html"> å·²å®Œæˆ</a>
 

<h2>ğŸ“¦ ç´§æ€¥è®¢å• | Báº£ng Ä‘Æ¡n hÃ ng gáº¥p</h2>
  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
  <input id="searchInput" placeholder="ğŸ” æœç´¢ è®¢å• / åŸæ–™ / æœºå™¨">

  <select id="sortField">
    <option value="">â€” æ’åº â€”</option>
    <option value="material">åŸæ–™</option>
    <option value="machineNo">æœºå™¨</option>
  </select>

  <select id="sortOrder">
    <option value="asc">â¬†ï¸ å‡åº</option>
    <option value="desc">â¬‡ï¸ é™åº</option>
  </select>
</div>


<table>
<thead>
<tr>
  <th>è®¢å•</th>
  <th>æœºå™¨</th>
  <th>åŸæ–™</th>
  <th>æ•°é‡</th>
  <th>æ—¥æœŸ</th>
  <th>ç±³æ•°</th>
  <th>å‘˜å·¥</th>
  <th>é”­ä½</th>
  <th>ä¼˜å…ˆ</th>
  <th>çŠ¶æ€</th>
  <th>æ“ä½œ</th>
</tr>
</thead>


<tbody>
<tr>
  <td><input id="orderName"></td>
  <td><input id="machine"></td>
  <td><input id="material"></td>
  <td><input id="quantity" type="number"></td>
  <td><input id="date" type="date"></td>
  <td><input id="meters" type="number"></td>
  <td>
    <select id="worker"></select>
  </td>

  <!-- âœ… Cá»˜T Gáº¤P -->
  <td>
    <select id="urgent">
      <option value="false">ä¸æ€¥</option>
      <option value="true">ğŸ”¥ æ€¥å•</option>
    </select>
  </td>

  <td>â³</td>
  <td><button id="addBtn" class="add-btn">æ·»åŠ </button></td>
</tr>
</tbody>


<tbody id="tableBody"></tbody>
</table>

<script>
// ================== Cáº¤U HÃŒNH ==================
const ADMIN_PASSWORD = "123456";

// ================== NHÃ‚N VIÃŠN ==================
const workers=["ä»»å¤§å“¥"];

// ================== FIREBASE ==================
firebase.initializeApp({
  apiKey:"AIzaSyAJ9dZW5b8WxF22cocPIB9bdsAGBHW-k",
  databaseURL:"https://quan-ly-may-det-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const soiRef=firebase.database().ref("soi");

// ================== DOM ==================
const orderName=document.getElementById("orderName");
const machine=document.getElementById("machine");
const material=document.getElementById("material");
const quantity=document.getElementById("quantity");
const date=document.getElementById("date");
const meters=document.getElementById("meters");
const worker=document.getElementById("worker");
const tableBody=document.getElementById("tableBody");
const addBtn=document.getElementById("addBtn");
  // ğŸ” SEARCH & SORT
const searchInput = document.getElementById("searchInput");
const sortField   = document.getElementById("sortField");
const sortOrder   = document.getElementById("sortOrder");

let rawData = {};


let editKey=null;
let alerted=false;
date.valueAsDate=new Date();

// load NV
workers.forEach(n=>{
  const o=document.createElement("option");
  o.value=n;o.textContent=n;
  worker.appendChild(o);
});

// ADD
addBtn.onclick=()=>{
  if(!orderName.value||!machine.value||!material.value||
     !quantity.value||!date.value||!meters.value||!worker.value){
    alert("è¯·è¾“å…¥å®Œæ•´ä¿¡æ¯ / Nháº­p Ä‘á»§ thÃ´ng tin");
    return;
  }

  const data={
  orderName:orderName.value,
  machine:machine.value,
  material:material.value,
  quantity:quantity.value,
  date:date.value,
  meters:meters.value,
  worker:worker.value,
  urgent: urgent.value === "true"
};


  // ğŸ”´ Náº¾U ÄANG Sá»¬A â†’ UPDATE
  if(editKey){
    soiRef.child(editKey).update(data);
    editKey = null;
    addBtn.textContent = "æ·»åŠ ";
    addBtn.className   = "add-btn";
  }
  // ğŸŸ¢ Náº¾U THÃŠM Má»šI â†’ PUSH
  else{
  soiRef.push({
  ...data,
  position:"",
  done:false,
  pushed:false,      // â›” CHÆ¯A Äáº¨Y XUá»NG MÃY
  createdAt:Date.now()
});
  }


  // reset form
  orderName.value=machine.value=material.value=
  quantity.value=meters.value=worker.value="";
  date.valueAsDate=new Date();
};

// LOAD
soiRef.on("value", s => {
  rawData = s.val() || {};
  applyFilter();
  alertRed(rawData);
});


// RENDER
function render(data){
  tableBody.innerHTML="";
  if(!data) return;

  Object.entries(data).forEach(([k,o])=>{

  // ğŸš« ÄÃƒ HOÃ€N THÃ€NH HOáº¶C ÄÃƒ Äáº¨Y â†’ KHÃ”NG HIá»‚N THá»Š
  if(o.done === true || o.pushed === true) return;


    const tr=document.createElement("tr");

// ğŸ”¹ ÄÆ¡n Ä‘ang xá»­ lÃ½ â†’ hiá»ƒn thá»‹ gá»n
if(!o.done){
  tr.classList.add("compact-row");
}

    const diff=(Date.now()-new Date(o.date))/86400000;

    if(o.urgent === true || o.urgent === "true"){
      tr.classList.add("level-red");
    }
    else if(diff >= 5){
      tr.classList.add("level-red");
    }
    else if(diff >= 2){
      tr.classList.add("level-yellow");
    }
    else{
      tr.classList.add("level-green");
    }

    tr.innerHTML=`
      <td>${o.orderName}</td>
      <td>${o.machine}</td>
      <td>${o.material}</td>
      <td>${o.quantity}</td>
      <td>${o.date}</td>
      <td>${o.meters} m</td>
      <td>${o.worker}</td>
      <td>${o.position||"-"}</td>
      <td>${o.urgent === true ? "ğŸ”¥ æ€¥å•" : "-"}</td>
      <td>â³ è¿›è¡Œä¸­</td>

      <td>
        <div class="action-col">
          <button class="push" onclick="pushToMachine('${k}')">â¬‡ï¸</button>
          <button class="edit" onclick="editRow('${k}')">âœï¸</button>
          <button class="delete" onclick="del('${k}')">ğŸ—‘ï¸</button>
        </div>

      </td>
    `;
    tableBody.appendChild(tr);
  });
}
  function applyFilter(){
  let arr = Object.entries(rawData || {})
    .filter(([k,o]) => !o.done && !o.pushed);

  // ğŸ” SEARCH
  const q = searchInput.value.toLowerCase();
  if(q){
    arr = arr.filter(([k,o]) =>
      (o.orderName||"").toLowerCase().includes(q) ||
      (o.material||"").toLowerCase().includes(q) ||
      (o.machine||"").toLowerCase().includes(q) ||
      (o.machineNo||"").toLowerCase().includes(q)
    );
  }

  // ğŸ”ƒ SORT
  const field = sortField.value;
  if(field){
    arr.sort((a,b)=>{
      const A = (a[1][field]||"").toString();
      const B = (b[1][field]||"").toString();
      return sortOrder.value === "asc"
        ? A.localeCompare(B,"zh")
        : B.localeCompare(A,"zh");
    });
  }

  render(Object.fromEntries(arr));
}



// DONE
function done(key){
  const pos=prompt("ğŸ“¦ è¾“å…¥é”­ä½ / Nháº­p vá»‹ trÃ­ con suá»‘t");
  if(!pos) return;
  soiRef.child(key).update({
  done:true,
  position:pos,
  doneAt: Date.now()
});
}

// DELETE
function del(k){
  const pw=prompt("ğŸ” è¾“å…¥ç®¡ç†å‘˜å¯†ç  / Nháº­p máº­t kháº©u quáº£n lÃ½");
  if(pw!==ADMIN_PASSWORD) return alert("âŒ Sai máº­t kháº©u");
  if(confirm("XoÃ¡ Ä‘Æ¡n nÃ y?")) soiRef.child(k).remove();
}

// ALERT ÄÆ N Äá»
function alertRed(data){
  if(alerted||!data) return;
  const n=Object.values(data).filter(o=>{
    const d=(Date.now()-new Date(o.date))/86400000;
    return !o.done && d>=5;
  }).length;
  if(n>0){
    alerted=true;
    alert(`âš ï¸ æœ‰ ${n} ä¸ªçº¢è‰²è®¢å•ï¼\nCÃ³ ${n} Ä‘Æ¡n quÃ¡ háº¡n!`);
  }
}
function editRow(key){
  soiRef.child(key).once("value", snap=>{
    const o = snap.val();

    if(o.done){
      alert("âŒ å·²å®Œæˆè®¢å•ä¸èƒ½ä¿®æ”¹\nÄÆ¡n Ä‘Ã£ hoÃ n thÃ nh khÃ´ng Ä‘Æ°á»£c sá»­a");
      return;
    }

    editKey = key;

    orderName.value = o.orderName;
    machine.value   = o.machine;
    material.value  = o.material;
    quantity.value  = o.quantity;
    date.value      = o.date;
    meters.value    = o.meters;
    worker.value    = o.worker;
    urgent.value = (o.urgent === true || o.urgent === "true")
      ? "true"
      : "false";


    addBtn.textContent = "ğŸ’¾ ä¿å­˜ / LÆ°u";
    addBtn.className   = "save-btn";
  });
}
function pushToMachine(key){
  const machineNo = prompt("ğŸ“¥ é€‰æœºå™¨ (vd: 1, 2, 11)");

  if(!machineNo) return alert("âŒæœºå™¨è¿˜æ²¡é€‰");

  soiRef.child(key).update({
    machineNo: machineNo,   // ğŸ‘ˆ MÃY THáº¬T
    pushed: true,
    pushedAt: Date.now()
  });

  alert("âœ… å·²ç»ä¸‹æ¨è®¢å• " + machineNo);
}

searchInput.oninput = applyFilter;
sortField.onchange  = applyFilter;
sortOrder.onchange  = applyFilter;

</script>

</body>
</html>














