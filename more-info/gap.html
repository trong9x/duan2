<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Báº¢NG ÄÆ N HÃ€NG Gáº¤P | ç´§æ€¥è®¢å•</title>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  padding: 20px;
}
h2 { text-align: center; }

.controls {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
  flex-wrap: wrap;
}
input, button { padding: 6px; }
button {
  border: none;
  border-radius: 5px;
  cursor: pointer;
}
.add-btn { background: #16a34a; color: #fff; }
.filter-btn { background: #2563eb; color: #fff; }
.reset-btn { background: #6b7280; color: #fff; }
.done-btn { background: #22c55e; color: #fff; }
.undo-btn { background: #f97316; color: #fff; }
.edit { background: #facc15; }
.delete { background: #ef4444; color: #fff; }

table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
}
th, td {
  padding: 8px;
  border-bottom: 1px solid #ddd;
  text-align: center;
}
th { background: #2563eb; color: #fff; }

.urgent { background: #fee2e2; }
.done {
  background: #e5e7eb;
  color: #6b7280;
  text-decoration: line-through;
}
</style>
</head>

<body>

<h2>ğŸ“¦ Báº¢NG ÄÆ N HÃ€NG Gáº¤P | ç´§æ€¥è®¢å•</h2>

<div class="controls">
  <input id="search" placeholder="ğŸ” æœç´¢ / TÃ¬m kiáº¿m">
  <button class="filter-btn" onclick="filterUrgent()">â° ç´§æ€¥</button>
  <button class="filter-btn" onclick="filterDone(true)">âœ… å·²å®Œæˆ</button>
  <button class="filter-btn" onclick="filterDone(false)">â³ æœªå®Œæˆ</button>
  <button class="reset-btn" onclick="loadAll()">â™»ï¸ å…¨éƒ¨</button>
</div>

<table>
<thead>
<tr>
  <th>è®¢å•å<br>TÃªn Ä‘Æ¡n</th>
  <th>æœºå™¨<br>TÃªn mÃ¡y</th>
  <th>åŸæ–™<br>NguyÃªn liá»‡u</th>
  <th>æ•°é‡<br>Sá»‘ lÆ°á»£ng</th>
  <th>æ—¥æœŸ<br>NgÃ y</th>
  <th>çŠ¶æ€<br>Tráº¡ng thÃ¡i</th>
  <th>æ“ä½œ<br>HÃ nh Ä‘á»™ng</th>
</tr>
</thead>

<!-- DÃ’NG NHáº¬P -->
<tbody>
<tr id="inputRow">
  <td><input id="orderName" placeholder="Order A001"></td>
  <td><input id="machine" placeholder="MÃ¡y 150"></td>
  <td><input id="material"></td>
  <td><input id="quantity" type="number"></td>
  <td><input id="date" type="date"></td>
  <td>â³ æœªå®Œæˆ</td>
  <td><button class="add-btn" id="addBtn">æ·»åŠ </button></td>
</tr>
</tbody>

<!-- Dá»® LIá»†U -->
<tbody id="tableBody"></tbody>
</table>

<script>
// ğŸ”¥ FIREBASE
firebase.initializeApp({
  apiKey: "AIzaSyAJ9dZW5b8WxF22cocPIB9bdsAGBHW-k",
  databaseURL: "https://quan-ly-may-det-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db = firebase.database();
const soiRef = db.ref("soi");

// DOM
const orderNameInput = document.getElementById("orderName");
const machineInput = document.getElementById("machine");
const materialInput = document.getElementById("material");
const quantityInput = document.getElementById("quantity");
const dateInput = document.getElementById("date");
const tableBody = document.getElementById("tableBody");
const searchInput = document.getElementById("search");
const addBtn = document.getElementById("addBtn");

dateInput.valueAsDate = new Date();

// â• ADD
addBtn.onclick = addOrder;
function addOrder() {
  if (
    !orderNameInput.value ||
    !machineInput.value ||
    !materialInput.value ||
    !quantityInput.value ||
    !dateInput.value
  ) {
    alert("è¯·è¾“å…¥å®Œæ•´ä¿¡æ¯ / Nháº­p Ä‘á»§ thÃ´ng tin");
    return;
  }

  soiRef.push({
    orderName: orderNameInput.value,
    machine: machineInput.value,
    material: materialInput.value,
    quantity: quantityInput.value,
    date: dateInput.value,
    done: false,
    createdAt: Date.now()
  });

  orderNameInput.value = "";
  machineInput.value = "";
  materialInput.value = "";
  quantityInput.value = "";
  dateInput.valueAsDate = new Date();
}

// ğŸ”„ LOAD ALL
function loadAll() {
  soiRef.off();
  soiRef.on("value", snap => {
    render(snap.val());
  });
}

// ğŸ§  RENDER
function render(data, filterFn = null) {
  tableBody.innerHTML = "";
  if (!data) return;

  Object.keys(data).forEach(key => {
    const o = data[key];
    if (!o || !o.material) return;
    if (filterFn && !filterFn(o)) return;

    const diff = (Date.now() - new Date(o.date)) / 86400000;
    const tr = document.createElement("tr");

    if (diff >= 2 && !o.done) tr.classList.add("urgent");
    if (o.done) tr.classList.add("done");

    tr.innerHTML = `
      <td>${o.orderName}</td>
      <td>${o.machine}</td>
      <td>${o.material}</td>
      <td>${o.quantity}</td>
      <td>${o.date}</td>
      <td>${o.done ? "âœ… å·²å®Œæˆ" : "â³ æœªå®Œæˆ"}</td>
      <td>
        <button class="${o.done ? "undo-btn" : "done-btn"}"
          onclick="toggleDone('${key}', ${o.done})">
          ${o.done ? "â†© æœªå®Œæˆ" : "âœ” å·²å®Œæˆ"}
        </button>
        <button class="edit"
          onclick="editOrder(
            '${key}',
            '${o.orderName}',
            '${o.machine}',
            '${o.material}',
            '${o.quantity}',
            '${o.date}'
          )">âœï¸</button>
        <button class="delete"
          onclick="deleteOrder('${key}')">ğŸ—‘ï¸</button>
      </td>
    `;
    tableBody.appendChild(tr);
  });
}

// ğŸ” DONE
function toggleDone(key, current) {
  soiRef.child(key).update({ done: !current });
}

// ğŸ—‘ï¸ DELETE
function deleteOrder(key) {
  if (confirm("åˆ é™¤æ­¤è®¢å•ï¼Ÿ / XoÃ¡ Ä‘Æ¡n nÃ y?")) {
    soiRef.child(key).remove();
  }
}

// âœï¸ EDIT
function editOrder(key, orderName, machine, m, q, d) {
  orderNameInput.value = orderName;
  machineInput.value = machine;
  materialInput.value = m;
  quantityInput.value = q;
  dateInput.value = d;

  addBtn.onclick = () => {
    soiRef.child(key).update({
      orderName: orderNameInput.value,
      machine: machineInput.value,
      material: materialInput.value,
      quantity: quantityInput.value,
      date: dateInput.value
    });

    addBtn.onclick = addOrder;
    orderNameInput.value = "";
    machineInput.value = "";
    materialInput.value = "";
    quantityInput.value = "";
    dateInput.valueAsDate = new Date();
  };
}

// ğŸ” SEARCH (tÃªn Ä‘Æ¡n + mÃ¡y + nguyÃªn liá»‡u)
searchInput.addEventListener("input", () => {
  const kw = searchInput.value.toLowerCase();
  soiRef.once("value", snap => {
    render(snap.val(), o =>
      o.orderName.toLowerCase().includes(kw) ||
      o.machine.toLowerCase().includes(kw) ||
      o.material.toLowerCase().includes(kw)
    );
  });
});

// â° URGENT
function filterUrgent() {
  soiRef.once("value", snap => {
    render(snap.val(), o =>
      !o.done && (Date.now() - new Date(o.date)) / 86400000 >= 2
    );
  });
}

// âœ… / â³ FILTER
function filterDone(status) {
  soiRef.once("value", snap => {
    render(snap.val(), o => o.done === status);
  });
}

loadAll();
</script>

</body>
</html>
